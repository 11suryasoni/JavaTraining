<!DOCTYPE html>
<html>
<!DOCTYPE html>
<html>

<head>

<body style="text-align:left;" id="body">
    <title>
        Table
    </title>
    <h1 style="color:darkcyan;">
        MUSEUM API - MONGO DB 
    </h1>

    <p id="GFG_UP" style="font-size: 15px; font-weight: bold;">
    </p>

    <button onclick="createTable('#table')">
        Click here to View table
    </button>

    <br><br>

    <div id="formID">
    </div>

    <div id="div"></div>
    <div>
        <table style="border: 1 ;" align="center" id="table" border="5"></table>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script>
        var response;
        var mainURL = "http://localhost:8080/MONGODB/webapi/myresource/find";
        $.getJSON(mainURL, function (result) {
            console.log("Inside the function");
            console.log(result);
            response = result;
            for (i = 0; i < result.length; i++)
                console.log(result[i]);
        });

        function handleDelete(data) {
            let id = "";
            Object.entries(data).forEach(([key, value]) => {

                if (key == "objectID") {
                    id = value;
                }

            }); fetch("http://localhost:8080/MONGODB/webapi/myresource/delete/" + id, {
                method: "DELETE",
                mode: "cors"
            }).then(response => response.text()).then(data => console.log(data)).catch(err => { console.log(err) });
        }
        function handleUpdate(data) {
            let p = "";
            let q = "";
            Object.entries(data).forEach(([key, val]) => {
                p += `<label>${key}<label><br>`;
                p += `<input type="text" id=${key} name=${key} value=${JSON.stringify(val)}></input><br>`;
            });
            p += `<button onclick=updateMethod(${JSON.stringify(data)})>Submit</button><br><br>`;
            document.getElementById("formID").innerHTML = p;
        }
        function handleInsert(data) {
            let p = "";
            let q = "";
            Object.entries(data).forEach(([key, val]) => {
                p += `<label>${key}<label><br>`;
                p += `<input type="text" id=${key} name=${key}></input><br>`;
            });
            console.log("form formed");
            p += `<button onclick=insertMethod(${JSON.stringify(data)})>Submit</button><br><br>`;
            document.getElementById("div").innerHTML = p;
        }

        function insertMethod(data) {
            let jsonString = "{";
            Object.entries(data).forEach(([key, val]) => {
                jsonString += `"${key}":"${document.getElementById(key).value}",`;
            });
            jsonString += "}";
            let json = jsonString.replace(",}", "}");
            console.log(json)

            fetch("http://localhost:8080/MONGODB/webapi/myresource/insert", {
                method: "POST",
                mode: "cors",
                Headers: {
                    'Content-Type': 'text/plain'
                },
                body: json
            }).then(response=>response.text()).then(data => alert(data)).catch((err) => console.log(err));
        }
        function updateMethod(data) {
            let jsonString = "{";
            Object.entries(data).forEach(([key, val]) => {

                let val1 = document.getElementById(key).value;
                jsonString += `"${key}":"${document.getElementById(key).value}",`;
            });
            jsonString += "}";
            var json = jsonString.replace(",}", "}");
            console.log(json)

            fetch("http://localhost:8080/MONGODB/webapi/myresource/update", {
                method: "PUT",
                mode: "cors",
                Headers: {
                    'Content-Type': 'text/plain'
                },
                body: json
                }).then(response=>response.text()).then(data => alert(data)).catch((err) => console.log(err));
        }

        function createTable(selector) {
            var column = Headers(response, selector);
            let insert = "";
            for (var i = 0; i < response.length; i++) {
                var row = $('<tr/>');
                for (var colIndex = 0; colIndex < column.length; colIndex++) {
                    var val = response[i][column[colIndex]];
                    if (val == null) val = "";
                    row.append($('<td/>').html(val));
                }
                row.append($(`<td><button style=\"background-color:blue;border-color:blue;color:white;\" onClick=handleUpdate(${JSON.stringify(response[i]).replace(/\s+/g, '')})>Update</button><br><br>`
                    + `<button style=\"background-color:red;border-color:red;color:white;\"  onClick=handleDelete(${JSON.stringify(response[i]).replace(/\s+/g, '')})>Delete</button><br><br>`));
                insert = `<button onClick=handleInsert(${JSON.stringify(response[i]).replace(/\s+/g, '')})>Insert Data</button><br><br>`;
                $(selector).append(row).html;
            }
            document.getElementById("div").innerHTML = insert;

        }


        function Headers(myresult, selector) {
            var columns = [];
            var header = $('<tr/>');
            for (var i = 0; i < myresult.length; i++) {
                var row = myresult[i];
                for (var k in row) {
                    if ($.inArray(k, columns) == -1) {
                        columns.push(k);
                        header.append($('<th/>').html(k));
                    }
                }
            }
            header.append($('<th>Action</th>'));
            $(selector).append(header);
            return columns;
        }


    </script>
    </head>

    <body>

        <div></div>

    </body>

</html>